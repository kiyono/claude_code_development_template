# Code Review ガイドライン

人力コードレビューのベストプラクティス。

---

## 1. コードレビューの目的

| 目的 | 説明 |
|------|------|
| 品質向上 | バグ、セキュリティ問題、設計上の欠陥を早期発見 |
| 知識共有 | チーム内での技術・ドメイン知識の伝播 |
| 一貫性維持 | コーディングスタイル、設計パターンの統一 |
| 学習機会 | レビュアー・レビュイー双方のスキル向上 |

**注意**: コードレビューは「批判」ではなく「協力」である。

---

## 2. レビュアーの心構え

### 2.1 基本姿勢

- **敬意を持つ**: コードではなく問題を批判する
- **建設的に**: 問題指摘だけでなく改善案を提示
- **質問形式**: 断定より質問で対話を促す
- **良い点も伝える**: 優れた実装には称賛を

### 2.2 コメントの書き方

**良い例:**

```
# 質問形式で理由を確認
このループで毎回 DB クエリを発行していますが、
N+1 問題を避けるために一括取得に変更できますか？

# 改善案を提示
ここは early return にすると可読性が上がりそうです。
例: if not condition: return None

# 良い点を伝える
このエラーハンドリングは網羅的で良いですね。
```

**悪い例:**

```
# NG: 理由がない
これは間違っている

# NG: 高圧的
なぜこんな書き方をしたのか理解できない

# NG: 曖昧
もっと良くできる
```

### 2.3 優先度の明示

コメントに優先度を付けて意図を明確にする:

| ラベル | 意味 | 対応 |
|--------|------|------|
| `[MUST]` | 必須修正（マージブロック） | 修正必須 |
| `[SHOULD]` | 強く推奨 | 修正推奨、理由があればスキップ可 |
| `[NIT]` | 軽微な指摘 | 対応任意 |
| `[QUESTION]` | 質問・確認 | 回答のみでOK |
| `[SUGGESTION]` | 提案 | 採用は任意 |

**例:**

```
[MUST] SQL インジェクションの脆弱性があります。
パラメータ化クエリに変更してください。

[NIT] 変数名 `d` より `document` の方が明確です。

[QUESTION] この例外を握りつぶしている理由を教えてください。
```

---

## 3. レビュイーの心構え

### 3.1 基本姿勢

- **謙虚に受け止める**: 指摘は成長の機会
- **防御的にならない**: コードへの批判は人格批判ではない
- **説明責任を果たす**: 意図や背景を丁寧に説明
- **感謝を伝える**: レビューは時間を割いてくれている

### 3.2 PR 作成のベストプラクティス

**レビューしやすい PR を作る:**

- **小さく保つ**: 200-400 行が目安、最大 500 行
- **単一目的**: 1 PR = 1 機能 or 1 修正
- **説明を書く**: 背景、変更内容、テスト方法を明記
- **セルフレビュー**: 提出前に自分でレビュー

**PR 説明テンプレート:**

```markdown
## 概要
何を、なぜ変更したか

## 変更内容
- 変更点1
- 変更点2

## テスト方法
- [ ] テストケース1
- [ ] テストケース2

## 関連 Issue
#123

## スクリーンショット（UI 変更時）
```

### 3.3 指摘への対応

| 指摘タイプ | 対応方法 |
|-----------|---------|
| 同意する | 修正して「対応しました」とコメント |
| 質問がある | 質問して議論、合意後に対応 |
| 同意しない | 理由を説明し、議論で解決 |
| 判断できない | 第三者の意見を求める |

---

## 4. レビュー観点

### 4.1 優先度順チェックリスト

#### CRITICAL（必須確認）

- [ ] **セキュリティ**
  - 認証・認可の適切性
  - 入力バリデーション
  - SQL/コマンドインジェクション
  - 機密情報の露出

- [ ] **データ整合性**
  - トランザクション境界
  - 競合状態（Race Condition）
  - データ損失リスク

#### HIGH（重要）

- [ ] **ロジックの正確性**
  - 境界条件の処理
  - エッジケースの考慮
  - エラーハンドリング

- [ ] **設計・アーキテクチャ**
  - 責務の適切な分離
  - 依存関係の方向
  - SOLID 原則の遵守

- [ ] **テスト**
  - テストの存在と網羅性
  - テストの独立性
  - テストの可読性

#### MEDIUM（推奨）

- [ ] **可読性**
  - 命名の明確さ
  - 適切なコメント
  - 関数・クラスの長さ

- [ ] **パフォーマンス**
  - 明らかな非効率（N+1 など）
  - 不要な処理

- [ ] **保守性**
  - 重複コード
  - マジックナンバー
  - 将来の変更容易性

#### LOW（任意）

- [ ] **スタイル**
  - フォーマット
  - import 順序
  - 空行・インデント

### 4.2 観点別の質問例

**ロジック:**
- この条件分岐で漏れているケースはないか？
- null/空の場合の動作は正しいか？
- 例外発生時の状態は適切か？

**設計:**
- この責務はこのクラスに適切か？
- 他のコンポーネントへの影響は考慮されているか？
- テストしやすい設計か？

**可読性:**
- 6 ヶ月後の自分が理解できるか？
- 変数名から意図が読み取れるか？
- コメントは必要十分か？

---

## 5. レビューフロー

### 5.1 標準フロー

```
1. PR 作成
   └── レビュイーがセルフレビュー実施
   └── レビュアーをアサイン

2. 初回レビュー（24 時間以内目標）
   └── 全体の設計・方針を確認
   └── 詳細なコードレビュー
   └── コメントを残す

3. 修正対応
   └── レビュイーが修正
   └── 各コメントに返信

4. 再レビュー
   └── 修正内容を確認
   └── 追加コメントがあれば記載

5. 承認・マージ
   └── LGTM（Looks Good To Me）
   └── マージ実行
```

### 5.2 タイムライン目安

| フェーズ | 目安時間 |
|---------|---------|
| 初回レビュー開始 | PR 作成から 24 時間以内 |
| 再レビュー | 修正から 12 時間以内 |
| 全体完了 | 3 営業日以内 |

**注意**: 大きな PR は時間がかかる。小さく分割することで迅速化。

### 5.3 承認基準

- [ ] CRITICAL/HIGH の指摘が全て解消
- [ ] 全ての `[MUST]` コメントが対応済み
- [ ] CI が全てパス
- [ ] 必要なテストが追加されている

---

## 6. アンチパターン

### 6.1 レビュアー側

| アンチパターン | 問題点 | 改善策 |
|--------------|--------|--------|
| 人格攻撃 | 信頼関係の破壊 | コードに焦点を当てる |
| 完璧主義 | レビューが終わらない | 優先度を付けて妥協点を見つける |
| 放置 | 開発速度の低下 | タイムボックスを設ける |
| スタイル固執 | 本質的でない議論 | リンターに任せる |
| 自分のやり方の押し付け | 多様性の否定 | 複数の正解があることを認める |

### 6.2 レビュイー側

| アンチパターン | 問題点 | 改善策 |
|--------------|--------|--------|
| 巨大 PR | レビュー困難 | 小さく分割 |
| 説明不足 | 意図が伝わらない | PR 説明を充実 |
| 防御的態度 | 建設的議論の阻害 | 指摘を学びの機会と捉える |
| 指摘の無視 | 品質低下 | 全てのコメントに返信 |
| 急かす | レビュー品質の低下 | 適切な時間を確保 |

---

## 7. リモートレビューの配慮

### 7.1 非同期コミュニケーション

- **コンテキストを十分に書く**: 口頭説明できない前提
- **トーンに注意**: 文字は冷たく見えがち
- **絵文字の活用**: 適度に使って柔らかく（任意）
- **即レス不要**: 非同期を前提に設計

### 7.2 同期コミュニケーションの活用

以下の場合は同期（ビデオ通話等）を検討:

- 複雑な設計議論
- 3 往復以上のやり取り
- 感情的になりそうな議論
- 新人へのフィードバック

---

## 8. レビュー効率化

### 8.1 自動化できること

| 項目 | ツール |
|------|--------|
| フォーマット | ruff format |
| リント | ruff check |
| 型チェック | mypy |
| テスト | pytest |
| カバレッジ | pytest-cov |
| セキュリティ | bandit, safety |

**原則**: 自動化できることは自動化し、人間は本質的なレビューに集中。

### 8.2 レビュー時間の目安

| PR サイズ | 行数 | レビュー時間 |
|----------|------|-------------|
| Small | ~100 行 | 15-30 分 |
| Medium | 100-300 行 | 30-60 分 |
| Large | 300-500 行 | 60-90 分 |
| X-Large | 500+ 行 | 分割を検討 |

### 8.3 効果的なレビュー手順

1. **PR 説明を読む**: 変更の目的と背景を理解
2. **全体を俯瞰**: ファイル一覧で変更範囲を把握
3. **テストから読む**: 期待動作を理解
4. **本体コードを読む**: テストの期待と照らし合わせ
5. **コメントを整理**: 優先度を付けて投稿

---

## 9. チェックリストサマリー

### レビュアー用

- [ ] 24 時間以内にレビュー開始したか
- [ ] 敬意を持ったコメントを書いたか
- [ ] 優先度ラベルを付けたか
- [ ] 改善案を提示したか
- [ ] 良い点も伝えたか

### レビュイー用

- [ ] PR は 500 行以下か
- [ ] PR 説明は十分か
- [ ] セルフレビューを実施したか
- [ ] CI は全てパスしているか
- [ ] 全てのコメントに返信したか

---

## 10. 参考資料

- [Google Engineering Practices - Code Review](https://google.github.io/eng-practices/review/)
- [Conventional Comments](https://conventionalcomments.org/)
- [How to Do Code Reviews Like a Human](https://mtlynch.io/human-code-reviews-1/)
